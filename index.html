<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lynq Payment Fields</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: transparent;
            padding: 16px;
            font-size: 16px;
        }

        .payment-fields {
            width: 100%;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: #fafafa;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        input.valid {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .card-icons {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            height: 20px;
        }

        .card-icon {
            width: 28px;
            height: 18px;
            border-radius: 3px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.3;
            transition: opacity 0.2s;
            border: 1px solid #e5e7eb;
        }

        .card-icon.active {
            opacity: 1;
            border-color: #667eea;
        }

        .card-icon.visa {
            background: #1a1f71;
            color: white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .card-icon.mastercard {
            background: linear-gradient(90deg, #eb001b 50%, #f79e1b 50%);
        }

        .card-icon.amex {
            background: #006fcf;
            color: white;
            font-size: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Hide elements when form is invalid */
        .form-invalid .submit-indicator {
            display: none;
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
<div class="payment-fields">
    <div class="form-group">
        <label for="card-number">Card Number</label>
        <input
                type="text"
                id="card-number"
                placeholder="1234 5678 9012 3456"
                maxlength="23"
                autocomplete="cc-number"
        >
        <div class="card-icons">
            <div class="card-icon visa">VISA</div>
            <div class="card-icon mastercard"></div>
            <div class="card-icon amex">AMEX</div>
        </div>
        <div class="error-message" id="card-number-error"></div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="card-expiry">Expiry Date</label>
            <input
                    type="text"
                    id="card-expiry"
                    placeholder="MM/YY"
                    maxlength="5"
                    autocomplete="cc-exp"
            >
            <div class="error-message" id="card-expiry-error"></div>
        </div>
        <div class="form-group">
            <label for="card-cvc">CVC</label>
            <input
                    type="text"
                    id="card-cvc"
                    placeholder="123"
                    maxlength="4"
                    autocomplete="cc-csc"
            >
            <div class="error-message" id="card-cvc-error"></div>
        </div>
    </div>

    <div class="form-group">
        <label for="card-name">Cardholder Name</label>
        <input
                type="text"
                id="card-name"
                placeholder="John Doe"
                autocomplete="cc-name"
        >
        <div class="error-message" id="card-name-error"></div>
    </div>
</div>

<script>
    class LynqPaymentFields {
        constructor() {
            this.config = this.parseUrlParams();
            this.formData = {};
            this.isValid = false;
            this.init();
        }

        parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                amount: parseInt(params.get('amount')) || 2999,
                currency: params.get('currency') || 'USD',
                apiKey: params.get('apiKey'),
                customerEmail: params.get('customerEmail'),
                environment: params.get('environment') || 'sandbox',
                metadata: params.get('metadata') ? JSON.parse(params.get('metadata')) : {}
            };
        }

        init() {
            this.setupEventListeners();
            this.setupPostMessageListeners();
            this.notifyReady();
        }

        setupEventListeners() {
            // Card number formatting and validation
            const cardNumberInput = document.getElementById('card-number');
            cardNumberInput.addEventListener('input', (e) => {
                e.target.value = this.formatCardNumber(e.target.value);
                this.validateCardNumber(e.target.value);
                this.detectCardType(e.target.value);
                this.checkFormValidity();
            });

            // Expiry formatting and validation
            const cardExpiryInput = document.getElementById('card-expiry');
            cardExpiryInput.addEventListener('input', (e) => {
                e.target.value = this.formatExpiry(e.target.value);
                this.validateExpiry(e.target.value);
                this.checkFormValidity();
            });

            // CVC validation
            const cardCvcInput = document.getElementById('card-cvc');
            cardCvcInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
                this.validateCvc(e.target.value);
                this.checkFormValidity();
            });

            // Name validation
            const cardNameInput = document.getElementById('card-name');
            cardNameInput.addEventListener('input', (e) => {
                this.validateName(e.target.value);
                this.checkFormValidity();
            });

            // Focus/blur events for better UX
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('focus', () => {
                    this.notifyFieldFocus(input.id);
                });

                input.addEventListener('blur', () => {
                    this.notifyFieldBlur(input.id);
                });
            });
        }

        setupPostMessageListeners() {
            window.addEventListener('message', (event) => {
                if (event.data.type === 'LYNQ_SUBMIT') {
                    this.handleSubmit();
                } else if (event.data.type === 'LYNQ_CLEAR') {
                    this.clearForm();
                }
            });
        }

        async handleSubmit() {
            if (!this.isValid) {
                this.notifyPaymentError({
                    code: 'INVALID_FORM',
                    message: 'Please fill in all required fields correctly'
                });
                return;
            }

            // Collect current form data
            this.formData = {
                cardNumber: document.getElementById('card-number').value.replace(/\s/g, ''),
                cardExpiry: document.getElementById('card-expiry').value,
                cardCvc: document.getElementById('card-cvc').value,
                cardName: document.getElementById('card-name').value,
                amount: this.config.amount,
                currency: this.config.currency,
                customerEmail: this.config.customerEmail,
                metadata: this.config.metadata
            };

            try {
                this.notifyProcessingStart();
                const result = await this.processPayment();
                this.notifyPaymentSuccess(result);
            } catch (error) {
                this.notifyPaymentError({
                    code: error.code || 'PAYMENT_FAILED',
                    message: error.message || 'Payment processing failed'
                });
            }
        }

        async processPayment() {
            // This would normally call your backend API
            // For now, simulate with a delay and random success/failure

            const response = await fetch(`${this.getApiUrl()}/v1/process-payment`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.config.apiKey}`,
                },
                body: JSON.stringify({
                    // Don't send raw card data - this would be tokenized first
                    cardToken: this.tokenizeCard(this.formData),
                    amount: this.formData.amount,
                    currency: this.formData.currency,
                    customerEmail: this.formData.customerEmail,
                    metadata: this.formData.metadata
                })
            });

            if (!response.ok) {
                throw new Error('Payment processing failed');
            }

            return await response.json();
        }

        tokenizeCard(cardData) {
            // In real implementation, this would securely tokenize the card
            // For demo, just return a mock token
            return 'tok_' + Math.random().toString(36).substr(2, 9);
        }

        getApiUrl() {
            return this.config.environment === 'production'
                ? 'https://api.lynqpay.com'
                : 'https://api-sandbox.lynqpay.com';
        }

        // Validation methods
        formatCardNumber(value) {
            const cleaned = value.replace(/\s/g, '');
            const match = cleaned.match(/(\d{1,4})(\d{1,4})?(\d{1,4})?(\d{1,4})?/);
            if (match) {
                return [match[1], match[2], match[3], match[4]]
                    .filter(Boolean)
                    .join(' ');
            }
            return cleaned;
        }

        formatExpiry(value) {
            const cleaned = value.replace(/\D/g, '');
            if (cleaned.length >= 2) {
                return cleaned.substring(0, 2) + '/' + cleaned.substring(2, 4);
            }
            return cleaned;
        }

        validateCardNumber(value) {
            const cleaned = value.replace(/\s/g, '');
            const input = document.getElementById('card-number');
            const errorEl = document.getElementById('card-number-error');

            if (cleaned.length === 0) {
                this.clearFieldState(input, errorEl);
                return false;
            } else if (cleaned.length < 13 || cleaned.length > 19) {
                this.showFieldError(input, errorEl, 'Invalid card number');
                return false;
            } else if (!this.luhnCheck(cleaned)) {
                this.showFieldError(input, errorEl, 'Invalid card number');
                return false;
            } else {
                this.showFieldValid(input, errorEl);
                return true;
            }
        }

        validateExpiry(value) {
            const input = document.getElementById('card-expiry');
            const errorEl = document.getElementById('card-expiry-error');

            if (value.length === 0) {
                this.clearFieldState(input, errorEl);
                return false;
            }

            const match = value.match(/^(\d{2})\/(\d{2})$/);
            if (!match) {
                this.showFieldError(input, errorEl, 'Invalid expiry date');
                return false;
            }

            const month = parseInt(match[1]);
            const year = parseInt('20' + match[2]);
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            if (month < 1 || month > 12) {
                this.showFieldError(input, errorEl, 'Invalid month');
                return false;
            }

            if (year < currentYear || (year === currentYear && month < currentMonth)) {
                this.showFieldError(input, errorEl, 'Card has expired');
                return false;
            }

            this.showFieldValid(input, errorEl);
            return true;
        }

        validateCvc(value) {
            const input = document.getElementById('card-cvc');
            const errorEl = document.getElementById('card-cvc-error');

            if (value.length === 0) {
                this.clearFieldState(input, errorEl);
                return false;
            } else if (value.length < 3 || value.length > 4) {
                this.showFieldError(input, errorEl, 'Invalid CVC');
                return false;
            } else {
                this.showFieldValid(input, errorEl);
                return true;
            }
        }

        validateName(value) {
            const input = document.getElementById('card-name');
            const errorEl = document.getElementById('card-name-error');

            if (value.trim().length === 0) {
                this.clearFieldState(input, errorEl);
                return false;
            } else if (value.trim().length < 2) {
                this.showFieldError(input, errorEl, 'Please enter cardholder name');
                return false;
            } else {
                this.showFieldValid(input, errorEl);
                return true;
            }
        }

        showFieldError(input, errorEl, message) {
            input.classList.add('error');
            input.classList.remove('valid');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        showFieldValid(input, errorEl) {
            input.classList.add('valid');
            input.classList.remove('error');
            errorEl.style.display = 'none';
        }

        clearFieldState(input, errorEl) {
            input.classList.remove('error', 'valid');
            errorEl.style.display = 'none';
        }

        detectCardType(value) {
            const cleaned = value.replace(/\s/g, '');
            const icons = document.querySelectorAll('.card-icon');
            icons.forEach(icon => icon.classList.remove('active'));

            if (/^4/.test(cleaned)) {
                document.querySelector('.card-icon.visa').classList.add('active');
            } else if (/^5[1-5]/.test(cleaned) || /^2[2-7]/.test(cleaned)) {
                document.querySelector('.card-icon.mastercard').classList.add('active');
            } else if (/^3[47]/.test(cleaned)) {
                document.querySelector('.card-icon.amex').classList.add('active');
            }
        }

        luhnCheck(value) {
            let sum = 0;
            let alternate = false;
            for (let i = value.length - 1; i >= 0; i--) {
                let n = parseInt(value.charAt(i));
                if (alternate) {
                    n *= 2;
                    if (n > 9) n = (n % 10) + 1;
                }
                sum += n;
                alternate = !alternate;
            }
            return sum % 10 === 0;
        }

        checkFormValidity() {
            const cardNumber = document.getElementById('card-number').value;
            const cardExpiry = document.getElementById('card-expiry').value;
            const cardCvc = document.getElementById('card-cvc').value;
            const cardName = document.getElementById('card-name').value;

            const wasValid = this.isValid;
            this.isValid =
                this.validateCardNumber(cardNumber) &&
                this.validateExpiry(cardExpiry) &&
                this.validateCvc(cardCvc) &&
                this.validateName(cardName);

            // Notify parent about form validity changes
            if (wasValid !== this.isValid) {
                this.notifyValidityChange(this.isValid);
            }

            this.autoResize();
        }

        clearForm() {
            document.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.classList.remove('error', 'valid');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.card-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            this.isValid = false;
            this.notifyValidityChange(false);
            this.autoResize();
        }

        // PostMessage communication with parent SDK
        notifyReady() {
            window.parent.postMessage({
                type: 'LYNQ_READY'
            }, '*');
            this.autoResize();
        }

        notifyValidityChange(isValid) {
            window.parent.postMessage({
                type: 'LYNQ_VALIDITY_CHANGE',
                payload: { isValid }
            }, '*');
        }

        notifyFieldFocus(fieldId) {
            window.parent.postMessage({
                type: 'LYNQ_FIELD_FOCUS',
                payload: { field: fieldId }
            }, '*');
        }

        notifyFieldBlur(fieldId) {
            window.parent.postMessage({
                type: 'LYNQ_FIELD_BLUR',
                payload: { field: fieldId }
            }, '*');
        }

        notifyProcessingStart() {
            window.parent.postMessage({
                type: 'LYNQ_PROCESSING_START'
            }, '*');
        }

        notifyPaymentSuccess(result) {
            window.parent.postMessage({
                type: 'LYNQ_PAYMENT_SUCCESS',
                payload: result
            }, '*');
        }

        notifyPaymentError(error) {
            window.parent.postMessage({
                type: 'LYNQ_PAYMENT_ERROR',
                payload: error
            }, '*');
        }

        autoResize() {
            setTimeout(() => {
                const height = document.body.scrollHeight;
                window.parent.postMessage({
                    type: 'LYNQ_RESIZE',
                    payload: { height: height + 10 }
                }, '*');
            }, 50);
        }
    }

    // Initialize payment fields
    let paymentFields;
    document.addEventListener('DOMContentLoaded', () => {
        paymentFields = new LynqPaymentFields();
    });
</script>
</body>
</html>